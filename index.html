<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js'></script>
    <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center relative">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR ğŸ“</h1>
            <p class="text-slate-400 text-sm">í˜¸ë‘ì´ ì„ ìƒë‹˜ ëª¨ë“œ ğŸ¯</p>
        </header>

        <section class="bg-slate-800 p-5 rounded-2xl shadow-xl border border-slate-700">
            <h2 class="text-sm font-bold text-emerald-400 mb-3">ğŸ“ˆ ì´ë²ˆ ì£¼ í•™ìŠµ ì§„í–‰ë„ (Tiáº¿n Ä‘á»™ tuáº§n nÃ y)</h2>
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700">
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>í•™ìŠµì¼: <span id="progDays" class="text-white font-bold text-sm">0</span> / 7ì¼</span>
                    <span>í‰ê·  ì •ë‹µë¥ : <span id="progRate" class="text-white font-bold text-sm">0</span>%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5 mb-3 overflow-hidden">
                    <div id="progBar" class="bg-gradient-to-r from-emerald-500 to-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progMessage" class="text-xs text-slate-400 italic text-center">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”!</p>
            </div>
            
            <button onclick="generateWeeklyReport()" id="reportBtn" class="w-full mt-4 bg-purple-600 hover:bg-purple-500 p-3 rounded-xl font-bold transition-all shadow-lg text-sm hidden">
                ğŸ“Š ì¼ì£¼ì¼ ì£¼ê°„ ì„±ì í‘œ & ì”ì†Œë¦¬ ë“£ê¸° (1000ì)
            </button>
        </section>

        <section class="bg-slate-800 p-5 rounded-2xl shadow-xl border border-red-500/50">
            <h2 class="text-sm font-bold text-red-400 mb-3">ğŸ”¥ ì˜¤ëŠ˜ì˜ í•™ìŠµ í• ë‹¹ëŸ‰ (Chá»‰ tiÃªu hÃ´m nay)</h2>
            <div class="flex justify-between items-center mb-3 text-sm">
                <span class="text-slate-300">ì˜¤ëŠ˜ì˜ ê¸°ë³¸ ë¬¸ì œ:</span>
                <span class="font-bold text-emerald-400">10ê°œ</span>
            </div>
            <div class="flex justify-between items-center mb-4 text-sm">
                <span class="text-slate-300">ë°€ë¦° ì´ì›” ë¬¸ì œ (No Mercy):</span>
                <span id="penaltyCount" class="font-bold text-red-400 text-lg">0ê°œ</span>
            </div>
            <div class="h-px bg-slate-700 w-full mb-4"></div>
            <div class="flex justify-between items-center font-bold text-xl">
                <span>ì´ ì¶œì œëŸ‰:</span>
                <span id="totalQuizCount" class="text-yellow-400">10ê°œ</span>
            </div>
        </section>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">âš™ï¸ API Settings & Dev Tools</summary>
            <div class="p-4 space-y-3">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm focus:border-emerald-500">
                <button onclick="simulateNextDay()" class="w-full bg-slate-700 p-2 rounded text-xs text-slate-300 hover:bg-slate-600 transition">[í…ŒìŠ¤íŠ¸ìš©] +1ì¼ íƒ€ì„ë¨¸ì‹  (í•˜ë£¨ ê²°ì„ ì²˜ë¦¬)</button>
            </div>
        </details>

        <section class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-xl">
            <textarea id="rawContent" rows="3" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500" placeholder="í•™ìŠµí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë³µì‚¬í•´ì„œ ë„£ìœ¼ì„¸ìš”..."></textarea>
            <button onclick="generateQuiz()" id="genBtn" class="w-full mt-3 bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold transition-all text-white shadow-lg">
                ğŸš€ <span id="btnQuizCount">10</span>ë¬¸ì œ ì¶œì œí•˜ê¸°
            </button>
        </section>

        <div id="naggingSection" class="hidden bg-red-900/40 p-6 rounded-2xl border border-red-500/50 shadow-xl">
            <h3 class="text-xl font-bold text-red-400 mb-2">ğŸ¤¬ 40ë…„ ë² í…Œë‘ì˜ íŒ©í­ ì§„ë‹¨</h3>
            <div id="naggingText" class="text-sm text-slate-200 leading-relaxed whitespace-pre-wrap"></div>
        </div>

        <div id="quizContainer" class="space-y-6 pb-10"></div>
    </div>

    <script>
        // --- [ìƒíƒœ ê´€ë¦¬: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„°ë² ì´ìŠ¤] ---
        let appState = JSON.parse(localStorage.getItem('ktutor_state')) || {
            lastLoginDate: new Date().toDateString(),
            missedDays: 0,
            quizHistory: [] // [{date: '...', score: 8, total: 10}]
        };

        const apiKeyInput = document.getElementById('apiKey');
        const penaltyCountEl = document.getElementById('penaltyCount');
        const totalQuizCountEl = document.getElementById('totalQuizCount');
        const btnQuizCountEl = document.getElementById('btnQuizCount');
        const reportBtn = document.getElementById('reportBtn');
        
        let currentTotalQuizzes = 10;
        let scoreCounter = 0;

        // --- ì´ˆê¸°í™”, í”„ë¡œê·¸ë ˆìŠ¤ ë°” ë° íƒ€ì„ë¨¸ì‹  ë¡œì§ ---
        function initApp() {
            apiKeyInput.value = localStorage.getItem('groq_key') || '';
            
            const today = new Date().toDateString();
            if (appState.lastLoginDate !== today) {
                const daysDiff = Math.floor((new Date(today) - new Date(appState.lastLoginDate)) / (1000 * 60 * 60 * 24));
                if (daysDiff > 0) {
                    appState.missedDays += daysDiff;
                    appState.lastLoginDate = today;
                    saveState();
                }
            }

            // ëˆ„ì  ê³„ì‚° (ê¸°ë³¸ 10 + ê²°ì„ì¼ * 10, ìµœëŒ€ 30ê°œ ì œí•œ)
            currentTotalQuizzes = 10 + (appState.missedDays * 10);
            if(currentTotalQuizzes > 30) currentTotalQuizzes = 30; 

            penaltyCountEl.innerText = `${appState.missedDays * 10}ê°œ`;
            totalQuizCountEl.innerText = `${currentTotalQuizzes}ê°œ`;
            btnQuizCountEl.innerText = currentTotalQuizzes;

            updateProgressUI();

            // ì£¼ê°„ ì„±ì í‘œ ë²„íŠ¼ í‘œì‹œ ì¡°ê±´ (íˆìŠ¤í† ë¦¬ê°€ 7ì¼ì¹˜ ì°¼ê±°ë‚˜ ê²°ì„ ëˆ„ì ì´ ì‹¬í•  ë•Œ)
            if (appState.quizHistory.length >= 7 || appState.missedDays >= 7) {
                reportBtn.classList.remove('hidden');
            }
        }

        // ì§„í–‰ë„ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressUI() {
            const history = appState.quizHistory;
            const daysStudied = history.length;
            let totalQ = 0;
            let totalCorrect = 0;

            history.forEach(h => {
                totalQ += h.total;
                totalCorrect += h.score;
            });

            const accuracy = totalQ === 0 ? 0 : Math.round((totalCorrect / totalQ) * 100);
            const progressPercent = Math.min((daysStudied / 7) * 100, 100);

            document.getElementById('progDays').innerText = daysStudied;
            document.getElementById('progRate').innerText = accuracy;
            document.getElementById('progBar').style.width = `${progressPercent}%`;

            const progMessage = document.getElementById('progMessage');
            if (daysStudied === 0) {
                progMessage.innerText = "ì´ë²ˆ ì£¼ ì²« í•™ìŠµì„ ì‹œì‘í•´ë³¼ê¹Œìš”? (Báº¯t Ä‘áº§u há»c nÃ o!)";
            } else if (daysStudied < 7) {
                progMessage.innerText = `ì˜í•˜ê³  ìˆì–´ìš”! ${7 - daysStudied}ì¼ë§Œ ë” ì±„ì›Œë³´ì„¸ìš”. (Cá»‘ lÃªn!)`;
            } else {
                progMessage.innerText = "ğŸ‰ ì¼ì£¼ì¼ ëª©í‘œ ë‹¬ì„±! ì•„ë˜ì—ì„œ ì£¼ê°„ í‰ê°€ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                progMessage.classList.add('text-emerald-400');
            }
        }

        function saveState() {
            localStorage.setItem('ktutor_state', JSON.stringify(appState));
        }

        function simulateNextDay() {
            appState.lastLoginDate = new Date(new Date().getTime() - (24 * 60 * 60 * 1000)).toDateString(); 
            saveState();
            location.reload();
        }

        initApp();

        // --- [í€´ì¦ˆ ìƒì„± ì—”ì§„] ---
        async function generateQuiz() {
            const key = apiKeyInput.value;
            const content = document.getElementById('rawContent').value;
            if (!key || !content.trim()) return alert("API í‚¤ì™€ í…ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”!");
            localStorage.setItem('groq_key', key);

            const genBtn = document.getElementById('genBtn');
            genBtn.innerText = `ğŸ‘¨â€ğŸ« ${currentTotalQuizzes}ë¬¸ì œ ì¶œì œ ì¤‘... â³`;
            genBtn.disabled = true;
            document.getElementById('quizContainer').innerHTML = '';
            scoreCounter = 0;

            const systemPrompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë¬´ì„œìš´ í˜¸ë‘ì´ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.

[â˜…ì–¸ì–´ ë¶„ë¦¬ ì ˆëŒ€ ê·œì¹™â˜…]
1. q_vn: 100% ë² íŠ¸ë‚¨ì–´ë¡œ ì§ˆë¬¸ ë° ìƒí™© ì„¤ëª… (ë¹ˆì¹¸ ë¬¸ì œì¼ ê²½ìš°ì—ë§Œ í•œêµ­ì–´ í…ìŠ¤íŠ¸ ì¼ë¶€ í¬í•¨)
2. options: 100% í•œêµ­ì–´ë¡œë§Œ ì‘ì„± (4ê°œ ë³´ê¸°)
3. exp: 100% ë² íŠ¸ë‚¨ì–´ë¡œ í•´ì„¤ ì‘ì„±

[ì¶œì œ ì§€ì¹¨]
- ìƒí™© ëŒ€ì²˜, ë¹ˆì¹¸ ì±„ìš°ê¸°, ì˜ë„ íŒŒì•… 3ê°€ì§€ ìœ í˜•ì„ ì„ì–´ì„œ ì¶œì œí•˜ì„¸ìš”.
- ë¬´ì¡°ê±´ 'ì •í™•íˆ ${currentTotalQuizzes}ë¬¸ì œ'ë¥¼ ë‹¤ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.

[JSON êµ¬ì¡°]
{ "questions": [ { "q_vn": "...", "options": ["..","..","..",".."], "a": 0, "exp": "..." } ] }`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: content }],
                        response_format: { type: "json_object" },
                        temperature: 0.4, 
                        max_tokens: 8000
                    })
                });

                const data = await res.json();
                const json = JSON.parse(data.choices[0].message.content);
                renderQuiz(json.questions);
            } catch (err) {
                alert("ì˜¤ë¥˜ ë°œìƒ!");
            } finally {
                genBtn.innerText = `ğŸš€ ${currentTotalQuizzes}ë¬¸ì œ ì¶œì œí•˜ê¸°`;
                genBtn.disabled = false;
            }
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quizContainer');
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                
                let optionsHtml = q.options.map((opt, oIdx) => `
                    <button onclick="handleAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}', ${questions.length})" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 mb-2 font-medium">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');

                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-emerald-100">${qIdx + 1}. ${q.q_vn}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-4 rounded-xl bg-slate-900 border-l-4 border-emerald-500 text-slate-300 leading-relaxed"></div>
                `;
                container.appendChild(qDiv);
            });
        }

        function handleAnswer(btn, qIdx, selected, correct, explanation, totalQ) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            const buttons = optionsDiv.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-emerald-400 text-base">âœ… <strong>ChÃ­nh xÃ¡c!</strong></span><br><br>${explanation}`;
                scoreCounter++;
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-red-400 text-base">âŒ <strong>Sai rá»“i!</strong></span><br><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');

            // ë§ˆì§€ë§‰ ë¬¸ì œ í’€ì´ ì™„ë£Œ ì‹œ
            if (document.querySelectorAll('.correct, .wrong').length === totalQ) {
                appState.quizHistory.push({ date: new Date().toDateString(), score: scoreCounter, total: totalQ });
                appState.missedDays = 0; // ê²°ì„ ì´ˆê¸°í™”
                saveState();
                
                setTimeout(() => {
                    alert(`ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ì´ ${totalQ}ë¬¸ì œ ì¤‘ ${scoreCounter}ë¬¸ì œ ì •ë‹µ!\në°€ë¦° ì´ì›” ë¬¸ì œê°€ ì´ˆê¸°í™”ë˜ê³  ì§„í–‰ë„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.reload();
                }, 500);
            }
        }

        // --- [ì¼ì£¼ì¼ ì£¼ê°„ ì„±ì í‘œ & 1000ì ì”ì†Œë¦¬ ì—”ì§„] ---
        async function generateWeeklyReport() {
            const key = apiKeyInput.value;
            if (!key) return;

            const btn = document.getElementById('reportBtn');
            btn.innerText = "ğŸ¤¬ ì„ ìƒë‹˜ì´ ì”ì†Œë¦¬ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤... â³";
            btn.disabled = true;

            const historyText = appState.quizHistory.map(h => `- ${h.date}: ${h.total}ë¬¸ì œ ì¤‘ ${h.score}ê°œ ì •ë‹µ`).join('\n');
            const systemPrompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë§¤ìš° ì—„ê²©í•˜ì§€ë§Œ í•™ìƒì„ ì•„ë¼ëŠ” í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.
í•™ìƒì˜ ì¼ì£¼ì¼ì¹˜ í€´ì¦ˆ ì„±ì ê³¼ ê²°ì„ ë°ì´í„°ê°€ ì œê³µë©ë‹ˆë‹¤. ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ë² íŠ¸ë‚¨ì–´'ë¡œ 1000ì ì´ìƒì˜ ì¥ë¬¸ í¸ì§€(ì”ì†Œë¦¬)ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

[í•„ìˆ˜ í¬í•¨ ë‚´ìš©]
1. íŒ©í­ ì§„ë‹¨: ì •ë‹µë¥ ê³¼ ì„±ì‹¤ë„ë¥¼ ì§€ì í•˜ì„¸ìš”. (ì˜ˆ: "ë¨¸ë¦¬ëŠ” ì¢‹ì€ë° ë…¸ë ¥ì„ ì•ˆ í•œë‹¤", "ëª°ì•„ì„œ í‘¸ëŠ” ê±´ ìµœì•…ì´ë‹¤" ë“±)
2. êµ¬ì²´ì ì¸ í•™ìŠµ ë°©í–¥: ë‹¤ìŒ ì£¼ ì§‘ì¤‘í•´ì•¼ í•  ë¶€ë¶„ì„ ì „ë¬¸ì ìœ¼ë¡œ ì¡°ì–¸í•˜ì„¸ìš”.
3. ì¸¤ë°ë ˆ ë§ˆë¬´ë¦¬: í˜¼ë‚´ê¸°ë§Œ í•˜ì§€ ë§ê³  ë§ˆì§€ë§‰ì—” ë”°ëœ»í•˜ê²Œ ì‘ì›í•´ì£¼ì„¸ìš”.
4. ì˜¤ì§ 'ë² íŠ¸ë‚¨ì–´'ë¡œë§Œ 1000ì ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `ë‹¤ìŒì€ í•™ìƒì˜ ì¼ì£¼ì¼ ì„±ì í‘œì…ë‹ˆë‹¤:\nê²°ì„ ì¼ìˆ˜ ëˆ„ì  ê¸°ë¡: ${appState.missedDays}ì¼ (í˜„ì¬ ë¦¬ì…‹ë¨)\nì„±ì  íˆìŠ¤í† ë¦¬:\n${historyText}` }
                        ],
                        temperature: 0.7 
                    })
                });

                const data = await res.json();
                const reportContent = data.choices[0].message.content;
                
                document.getElementById('naggingSection').classList.remove('hidden');
                document.getElementById('naggingText').innerText = reportContent;
                
                if(confirm("ì”ì†Œë¦¬ë¥¼ ë‹¤ ì½ìœ¼ì…¨ë‚˜ìš”? í™•ì¸ì„ ëˆ„ë¥´ë©´ ì§€ë‚œì£¼ ì„±ì  ê¸°ë¡ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ê³  ìƒˆë¡œìš´ ì£¼ê°„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")) {
                    appState.quizHistory = [];
                    saveState();
                    updateProgressUI();
                }

            } catch (err) {
                alert("ì”ì†Œë¦¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
            } finally {
                btn.innerText = "ğŸ“Š ì¼ì£¼ì¼ ì£¼ê°„ ì„±ì í‘œ & ì”ì†Œë¦¬ ë“£ê¸° (1000ì)";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
