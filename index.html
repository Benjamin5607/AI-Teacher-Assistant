<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src='https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js'></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
        .tab-btn.active { background-color: #059669; color: white; border-color: #059669; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR ğŸ“</h1>
            <p class="text-slate-400 text-sm">For My Vietnamese Student</p>
        </header>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">âš™ï¸ API Settings</summary>
            <div class="p-4">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm focus:border-emerald-500 focus:outline-none">
            </div>
        </details>

        <section class="bg-slate-800 rounded-2xl shadow-xl border border-slate-700 overflow-hidden">
            <div class="flex border-b border-slate-700 text-sm">
                <button onclick="switchTab('text')" id="tab-text" class="tab-btn active flex-1 py-3 text-center text-slate-400 hover:text-white transition">ğŸ“ í…ìŠ¤íŠ¸</button>
                <button onclick="switchTab('file')" id="tab-file" class="tab-btn flex-1 py-3 text-center text-slate-400 hover:text-white transition">ğŸ“ íŒŒì¼/ì‚¬ì§„</button>
            </div>
            
            <div class="p-6">
                <div id="input-text" class="block">
                    <textarea id="textContent" rows="4" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500" placeholder="ê³µë¶€í•  ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    <button onclick="processInput('text')" class="w-full mt-3 bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl font-bold transition-all shadow-lg">ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
                </div>

                <div id="input-file" class="hidden space-y-4">
                    <label class="block cursor-pointer group">
                        <div class="bg-slate-900 border border-dashed border-slate-500 group-hover:border-emerald-500 p-6 rounded-xl text-center transition-all">
                            <span class="block text-2xl mb-2">ğŸ“¸ / ğŸ“„</span>
                            <span class="text-sm text-slate-400 group-hover:text-emerald-400">ì‚¬ì§„ ì´¬ì˜ ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ<br>(PDF, Word, Excel, CSV ë“±)</span>
                        </div>
                        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.json" capture="environment" class="hidden">
                    </label>
                </div>
            </div>
        </section>

        <section id="analysisSection" class="hidden bg-slate-800 p-6 rounded-2xl shadow-xl border border-emerald-500/50 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-blue-500"></div>
            <h2 class="text-sm font-bold text-emerald-400 mb-2">ğŸ¤– AIê°€ íŒŒì•…í•œ í•™ìŠµ ë‚´ìš©</h2>
            <div id="aiSummary" class="text-sm text-slate-300 leading-relaxed mb-4 bg-slate-900 p-4 rounded-lg">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
            
            <button onclick="generateQuiz()" id="genBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold transition-all disabled:opacity-50 text-white shadow-lg">
                ğŸš€ ì‹¤ì „ í€´ì¦ˆ 10ë¬¸ì œ ì¶œì œí•˜ê¸°
            </button>
        </section>

        <div id="loadingStatus" class="hidden text-center text-sm font-bold text-yellow-400 animate-pulse">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</div>

        <div id="quizContainer" class="space-y-6 pb-10"></div>
    </div>

    <script>
        // PDF.js ì›Œì»¤ ì„¸íŒ…
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // UI ìš”ì†Œ
        const fileInput = document.getElementById('fileInput');
        const textContent = document.getElementById('textContent');
        const analysisSection = document.getElementById('analysisSection');
        const aiSummary = document.getElementById('aiSummary');
        const loadingStatus = document.getElementById('loadingStatus');
        const quizContainer = document.getElementById('quizContainer');
        const genBtn = document.getElementById('genBtn');
        
        let cleanedContext = ""; // AIê°€ ì •ë¦¬í•œ í•µì‹¬ ë‚´ìš© ì €ì¥ìš© ë³€ìˆ˜

        // í‚¤ ìë™ ë¡œë“œ
        document.getElementById('apiKey').value = localStorage.getItem('groq_key') || '';

        // íƒ­ ì „í™˜ ë¡œì§
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-white'));
            document.getElementById(`tab-${tabId}`).classList.add('active', 'text-white');
            
            document.getElementById('input-text').classList.add('hidden');
            document.getElementById('input-file').classList.add('hidden');
            document.getElementById(`input-${tabId}`).classList.remove('hidden');
        }

        // --- [í•µì‹¬ 1] ë§ŒëŠ¥ íŒŒì¼ íŒŒì„œ ---
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading("â³ íŒŒì¼ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤... (Äang Ä‘á»c file...)");
            analysisSection.classList.add('hidden');
            quizContainer.innerHTML = '';
            let rawText = "";

            try {
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (file.type.startsWith('image/')) {
                    // 1. ì´ë¯¸ì§€ (Tesseract)
                    const result = await Tesseract.recognize(file, 'kor+eng');
                    rawText = result.data.text;
                } else if (ext === 'pdf') {
                    // 2. PDF
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        rawText += textContent.items.map(item => item.str).join(' ') + " ";
                    }
                } else if (ext === 'docx' || ext === 'doc') {
                    // 3. Word
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    rawText = result.value;
                } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                    // 4. Excel / CSV
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    rawText = XLSX.utils.sheet_to_csv(firstSheet);
                } else {
                    // 5. TXT, JSON ë“± ì¼ë°˜ í…ìŠ¤íŠ¸
                    rawText = await file.text();
                }

                if(rawText.trim().length < 5) throw new Error("í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                
                // í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ í›„ AI ìš”ì•½ìœ¼ë¡œ ë„˜ê¹€
                await analyzeWithAI(rawText);

            } catch (err) {
                console.error(err);
                hideLoading();
                alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì‚¬ì§„ì´ ë„ˆë¬´ íë¦¬ê±°ë‚˜ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
        };

        // í…ìŠ¤íŠ¸ ìˆ˜ë™ ì…ë ¥ ì²˜ë¦¬
        function processInput(type) {
            if(type === 'text') {
                const text = textContent.value;
                if(!text.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                analysisSection.classList.add('hidden');
                quizContainer.innerHTML = '';
                analyzeWithAI(text);
            }
        }

        // --- [í•µì‹¬ 2] ì™¸ê³„ì–´ ë²ˆì—­ ë° ë‚´ìš© ìš”ì•½ AI ---
        async function analyzeWithAI(rawText) {
            const key = document.getElementById('apiKey').value;
            if (!key) return alert("API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
            localStorage.setItem('groq_key', key);

            showLoading("ğŸ¤– AIê°€ ë‚´ìš©ì„ íŒŒì•…í•˜ê³  ì™¸ê³„ì–´ë¥¼ êµì • ì¤‘ì…ë‹ˆë‹¤...");

            const systemPrompt = `ë‹¹ì‹ ì€ ë˜‘ë˜‘í•œ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìê°€ ë³´ë‚¸ í…ìŠ¤íŠ¸ëŠ” OCRì´ë‚˜ ë¬¸ì„œì—ì„œ ì¶”ì¶œë˜ì–´ ì˜¤íƒ€ë‚˜ ê¹¨ì§„ ê¸€ì(ì™¸ê³„ì–´)ê°€ ì„ì—¬ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê¹¨ì§„ ê¸€ìëŠ” ë¬´ì‹œí•˜ê³ , ë¬¸ë§¥ì„ íŒŒì•…í•˜ì—¬ 'ì´ ë‚´ìš©ì´ ì–´ë–¤ í•œêµ­ì–´ í•™ìŠµ(ì–´íœ˜, ë¬¸ë²•, ìƒí™© ë“±)ì„ ë‹¤ë£¨ê³  ìˆëŠ”ì§€' íŒŒì•…í•˜ì„¸ìš”.
ê²°ê³¼ëŠ” 2~3ì¤„ì˜ ê¹”ë”í•œ í•œêµ­ì–´ ìš”ì•½ê³¼ ë² íŠ¸ë‚¨ì–´ ë²ˆì—­ìœ¼ë¡œë§Œ ëŒ€ë‹µí•˜ì„¸ìš”. JSONì´ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ë‹µí•˜ì„¸ìš”.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”:\n\n${rawText.substring(0, 3000)}` } // ë„ˆë¬´ ê¸´ ë¬¸ì„œ ë°©ì§€
                        ],
                        temperature: 0.3
                    })
                });

                const data = await res.json();
                cleanedContext = data.choices[0].message.content; // ì •ë¦¬ëœ ë‚´ìš©ì„ ë³€ìˆ˜ì— ì €ì¥ (í€´ì¦ˆ ì¶œì œìš©)
                
                hideLoading();
                aiSummary.innerText = cleanedContext;
                analysisSection.classList.remove('hidden');

            } catch (err) {
                hideLoading();
                alert("AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // --- [í•µì‹¬ 3] ì‹¤ì „ í€´ì¦ˆ ìƒì„± (íšŒìƒ‰ ê¸€ì”¨ ì œê±° ì™„ë£Œ!) ---
        async function generateQuiz() {
            const key = document.getElementById('apiKey').value;
            
            genBtn.innerText = "ğŸ‘¨â€ğŸ« ë¬¸ì œ ì¶œì œ ì¤‘... â³";
            genBtn.disabled = true;
            quizContainer.innerHTML = '';

            // q_kr ì™„ì „ ì‚­ì œ, ì˜¤ì§ q_vnê³¼ options(í•œêµ­ì–´)ë§Œ ë‚¨ê¹€
            const systemPrompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.
ì œê°€ ì œê³µí•˜ëŠ” 'ìš”ì•½ëœ í•™ìŠµ ë‚´ìš©'ì„ ë°”íƒ•ìœ¼ë¡œ, ì•„ë˜ 3ê°€ì§€ ìœ í˜• ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ ì´ 10ë¬¸ì œë¥¼ ì¶œì œí•˜ì„¸ìš”.

[â˜…ì–¸ì–´ ë¶„ë¦¬ ì ˆëŒ€ ê·œì¹™â˜… - ì‹œìŠ¤í…œ ê²½ê³ : ì´ ê·œì¹™ì„ ì–´ê¸°ë©´ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤]
1. ì§ˆë¬¸(q_vn): ë¬´ì¡°ê±´ 100% 'ë² íŠ¸ë‚¨ì–´(Vietnamese)'ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ìƒí™© ì„¤ëª…ë„ ëª¨ë‘ ë² íŠ¸ë‚¨ì–´ì…ë‹ˆë‹¤.
2. ë³´ê¸°(options): ë¬´ì¡°ê±´ 100% 'í•œêµ­ì–´(Korean)'ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”. ë³´ê¸°ì— ë² íŠ¸ë‚¨ì–´, ì˜ì–´, ì•ŒíŒŒë²³ì´ ë‹¨ í•œ ê¸€ìë¼ë„ ì„ì´ë©´ ì ˆëŒ€ ì•ˆ ë©ë‹ˆë‹¤.
3. í•´ì„¤(exp): ë¬´ì¡°ê±´ 100% 'ë² íŠ¸ë‚¨ì–´(Vietnamese)'ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.

[ì¶œì œ ìœ í˜•]
1. ìƒí™© ëŒ€ì²˜: ë² íŠ¸ë‚¨ì–´ë¡œ ìƒí™©ì„ ì„¤ëª…í•˜ê³ , ê°€ì¥ ì•Œë§ì€ 'í•œêµ­ì–´' ëŒ€ì‚¬ë¥¼ ê³ ë¥´ê²Œ í•˜ì„¸ìš”.
2. ë¹ˆì¹¸ ì±„ìš°ê¸°: ë² íŠ¸ë‚¨ì–´ë¡œ ë¬¸ë§¥ì„ ì„¤ëª…í•˜ê³ , ë¹ˆì¹¸(____)ì´ ìˆëŠ” 'í•œêµ­ì–´' ë¬¸ì¥ì„ ì œì‹œí•˜ì—¬ ì•Œë§ì€ 'í•œêµ­ì–´' ë‹¨ì–´ë¥¼ ê³ ë¥´ê²Œ í•˜ì„¸ìš”.
3. ì˜ë„ íŒŒì•…: ë² íŠ¸ë‚¨ì–´ë¡œ "ì´ í•œêµ­ì–´ ë¬¸ì¥ì€ ì–´ë–¤ ìƒí™©ì— ì“°ì´ë‚˜ìš”?"ë¼ê³  ë¬»ê³ , ë³´ê¸°ë¥¼ êµ¬ì„±í•˜ì„¸ìš”.

[JSON êµ¬ì¡°]
{
  "questions": [
    {
      "q_vn": "ë² íŠ¸ë‚¨ì–´ ì§ˆë¬¸ (Vietnamese ONLY)",
      "options": ["ì˜¤ì§ í•œêµ­ì–´", "ì˜¤ì§ í•œêµ­ì–´", "ì˜¤ì§ í•œêµ­ì–´", "ì˜¤ì§ í•œêµ­ì–´"],
      "a": 0,
      "exp": "ë² íŠ¸ë‚¨ì–´ í•´ì„¤ (Vietnamese ONLY)"
    }
  ]
}`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `ë‹¤ìŒ í•™ìŠµ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ 10ë¬¸ì œë¥¼ ë‚´ì£¼ì„¸ìš”:\n\n${cleanedContext}` }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.4, 
                        max_tokens: 6000
                    })
                });

                const data = await res.json();
                
                if (data.choices && data.choices[0].message.content) {
                    const json = JSON.parse(data.choices[0].message.content);
                    renderQuiz(json.questions);
                }
            } catch (err) {
                console.error(err);
                alert("AI ì¶œì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                genBtn.innerText = "ğŸš€ ì‹¤ì „ í€´ì¦ˆ 10ë¬¸ì œ ì¶œì œí•˜ê¸°";
                genBtn.disabled = false;
            }
        }

        // í€´ì¦ˆ ë Œë”ë§ (q_kr ì‚­ì œ, q_vnë§Œ ë Œë”ë§)
        function renderQuiz(questions) {
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                
                let optionsHtml = q.options.map((opt, oIdx) => `
                    <button onclick="checkAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}')" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 transition-all text-base mb-2 font-medium">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');

                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-emerald-100 leading-relaxed">${qIdx + 1}. ${q.q_vn}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-4 rounded-xl bg-slate-900 border-l-4 border-emerald-500 text-slate-300 leading-relaxed shadow-inner"></div>
                `;
                quizContainer.appendChild(qDiv);
            });
        }

        function checkAnswer(btn, qIdx, selected, correct, explanation) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            const buttons = optionsDiv.querySelectorAll('button');

            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-emerald-400 text-base">âœ… <strong>ChÃ­nh xÃ¡c! (ì •ë‹µ!)</strong></span><br><br>${explanation}`;
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-red-400 text-base">âŒ <strong>Sai rá»“i! (í‹€ë ¸ì–´ìš”!)</strong></span><br><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function showLoading(msg) {
            loadingStatus.innerText = msg;
            loadingStatus.classList.remove('hidden');
        }
        function hideLoading() {
            loadingStatus.classList.add('hidden');
        }
    </script>
</body>
</html>
