<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src='https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js'></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 

    <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
        .tab-btn.active { background-color: #059669; color: white; border-color: #059669; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center relative">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR ğŸ“</h1>
            <p class="text-slate-400 text-sm">í˜¸ë‘ì´ ì„ ìƒë‹˜ ëª¨ë“œ ğŸ¯ (1ì£¼ì¼ ì™„ì„±)</p>
        </header>

        <section class="bg-slate-800 p-5 rounded-2xl shadow-xl border border-slate-700">
            <h2 class="text-sm font-bold text-emerald-400 mb-3">ğŸ“ˆ ì´ë²ˆ ì£¼ í•™ìŠµ ì§„í–‰ë„ (Tiáº¿n Ä‘á»™ tuáº§n nÃ y)</h2>
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mb-3">
                <div class="flex justify-between text-xs text-slate-400 mb-2">
                    <span>í•™ìŠµì¼: <span id="progDays" class="text-white font-bold text-sm">0</span> / 7ì¼</span>
                    <span>í‰ê·  ì •ë‹µë¥ : <span id="progRate" class="text-white font-bold text-sm">0</span>%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5 mb-3 overflow-hidden">
                    <div id="progBar" class="bg-gradient-to-r from-emerald-500 to-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progMessage" class="text-xs text-slate-400 italic text-center">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ êµì¬ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”!</p>
            </div>
            
            <button onclick="generateWeeklyReport()" id="reportBtn" class="w-full bg-purple-600 hover:bg-purple-500 p-3 rounded-xl font-bold transition-all shadow-lg text-sm hidden">
                ğŸ“Š ì¼ì£¼ì¼ í‰ê°€ & ì”ì†Œë¦¬ ë“£ê¸° (1000ì)
            </button>
        </section>

        <section id="currentStudySection" class="hidden bg-slate-800 p-5 rounded-2xl shadow-xl border border-red-500/50">
            <h2 class="text-sm font-bold text-red-400 mb-2">ğŸ”¥ í˜„ì¬ í•™ìŠµ ì¤‘ì¸ ë‚´ìš© ë° í• ë‹¹ëŸ‰</h2>
            <div id="savedMaterialBox" class="text-xs text-slate-300 bg-slate-900 p-3 rounded-lg border border-slate-700 mb-4 h-24 overflow-y-auto leading-relaxed"></div>
            
            <div class="flex justify-between items-center text-sm mb-2">
                <span class="text-slate-300">ì˜¤ëŠ˜ì˜ ê¸°ë³¸ ë¬¸ì œ:</span><span class="text-emerald-400 font-bold">10ê°œ</span>
            </div>
            <div class="flex justify-between items-center text-sm mb-4">
                <span class="text-slate-300">ê²°ì„ í˜ë„í‹° (No Mercy):</span><span id="penaltyCount" class="text-red-400 font-bold">0ê°œ</span>
            </div>
            <button onclick="generateQuiz()" id="genBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold transition-all text-white shadow-lg">
                ğŸš€ ì´ <span id="btnQuizCount">10</span>ë¬¸ì œ ì¶œì œ ë° í’€ê¸°
            </button>
        </section>

        <details id="uploadDetails" class="bg-slate-800 rounded-xl border border-slate-700" open>
            <summary class="p-3 text-xs text-slate-400 cursor-pointer font-bold">ğŸ“ ìƒˆë¡œìš´ êµì¬ ì—…ë¡œë“œ (ìƒˆë¡œìš´ ì£¼ê°„ ì‹œì‘)</summary>
            
            <div class="border-t border-slate-700 text-sm flex">
                <button onclick="switchTab('text')" id="tab-text" class="tab-btn active flex-1 py-3 text-center text-slate-400 hover:text-white transition">ğŸ“ í…ìŠ¤íŠ¸</button>
                <button onclick="switchTab('file')" id="tab-file" class="tab-btn flex-1 py-3 text-center text-slate-400 hover:text-white transition">ğŸ“¸ ì‚¬ì§„/íŒŒì¼</button>
            </div>
            
            <div class="p-4">
                <div id="input-text" class="block">
                    <textarea id="textContent" rows="3" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500" placeholder="ìƒˆë¡œìš´ í•™ìŠµ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
                    <button onclick="processInput('text')" class="w-full mt-3 bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl font-bold transition-all shadow-lg text-sm text-white">AI ìš”ì•½ ë° ìƒˆë¡œìš´ ì£¼ê°„ í•™ìŠµ ì‹œì‘</button>
                </div>

                <div id="input-file" class="hidden space-y-4">
                    <label class="block cursor-pointer group">
                        <div class="bg-slate-900 border border-dashed border-slate-500 group-hover:border-emerald-500 p-6 rounded-xl text-center transition-all">
                            <span class="block text-2xl mb-2">ğŸ“¸ / ğŸ“„</span>
                            <span class="text-xs text-slate-400 group-hover:text-emerald-400">ì‚¬ì§„ ì´¬ì˜ ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ<br>(PDF, Word, Excel ë“±)</span>
                        </div>
                        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.json" capture="environment" class="hidden">
                    </label>
                </div>
            </div>
        </details>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">âš™ï¸ API Settings & Dev Tools</summary>
            <div class="p-4 space-y-3">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm focus:border-emerald-500">
                <button onclick="simulateNextDay()" class="w-full bg-slate-700 p-2 rounded text-xs text-slate-300 hover:bg-slate-600 transition">[í…ŒìŠ¤íŠ¸ìš©] +1ì¼ íƒ€ì„ë¨¸ì‹  (í•˜ë£¨ ê²°ì„ ì²˜ë¦¬)</button>
            </div>
        </details>

        <div id="loadingStatus" class="hidden text-center text-sm font-bold text-yellow-400 animate-pulse bg-slate-800 p-4 rounded-xl border border-yellow-500/50">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</div>
        
        <div id="naggingSection" class="hidden bg-red-900/40 p-6 rounded-2xl border border-red-500/50 shadow-xl">
            <h3 class="text-xl font-bold text-red-400 mb-2">ğŸ¤¬ 40ë…„ ë² í…Œë‘ì˜ íŒ©í­ ì§„ë‹¨</h3>
            <div id="naggingText" class="text-sm text-slate-200 leading-relaxed whitespace-pre-wrap"></div>
        </div>

        <div id="quizContainer" class="space-y-6 pb-10"></div>
    </div>

    <div id="closingModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-purple-500/50 shadow-2xl">
            <h3 class="text-xl font-bold text-purple-400 mb-3">ğŸ›‘ í˜¸ë‘ì´ ì„ ìƒë‹˜ì˜ ë§ˆì§€ë§‰ í˜¸ì¶œ</h3>
            <div class="bg-slate-900 p-4 rounded-xl mb-5 h-48 overflow-y-auto">
                <p id="closingReportText" class="text-sm text-slate-300 leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="cancelReset()" class="flex-1 bg-slate-600 hover:bg-slate-500 p-3 rounded-xl text-sm font-bold text-white transition">
                    ì·¨ì†Œ (ê¸°ì¡´ êµì¬ ìœ ì§€)
                </button>
                <button onclick="confirmResetAndProcess()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 p-3 rounded-xl text-sm font-bold text-white transition shadow-lg">
                    ì”ì†Œë¦¬ ëª…ì‹¬! ìƒˆ êµì¬ ì‹œì‘
                </button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- ìƒíƒœ ê´€ë¦¬ ---
        let appState = JSON.parse(localStorage.getItem('ktutor_state')) || {
            material: "", 
            lastLoginDate: new Date().toDateString(),
            missedDays: 0,
            quizHistory: []
        };

        const apiKeyInput = document.getElementById('apiKey');
        const penaltyCountEl = document.getElementById('penaltyCount');
        const btnQuizCountEl = document.getElementById('btnQuizCount');
        const reportBtn = document.getElementById('reportBtn');
        const currentStudySection = document.getElementById('currentStudySection');
        const uploadDetails = document.getElementById('uploadDetails');
        
        let currentTotalQuizzes = 10;
        let scoreCounter = 0;
        let pendingNewRawText = ""; // í™˜ìŠ¹ ëŒ€ê¸° ì¤‘ì¸ ìƒˆ êµì¬ í…ìŠ¤íŠ¸

        function saveState() { localStorage.setItem('ktutor_state', JSON.stringify(appState)); }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-white'));
            document.getElementById(`tab-${tabId}`).classList.add('active', 'text-white');
            document.getElementById('input-text').classList.add('hidden');
            document.getElementById('input-file').classList.add('hidden');
            document.getElementById(`input-${tabId}`).classList.remove('hidden');
        }

        // --- ì´ˆê¸°í™” ë¡œì§ ---
        function initApp() {
            apiKeyInput.value = localStorage.getItem('groq_key') || '';
            const today = new Date().toDateString();
            
            if (appState.material && appState.lastLoginDate !== today) {
                const daysDiff = Math.floor((new Date(today) - new Date(appState.lastLoginDate)) / (1000 * 60 * 60 * 24));
                if (daysDiff > 0) {
                    appState.missedDays += daysDiff;
                    appState.lastLoginDate = today;
                    saveState();
                }
            }

            if (appState.material) {
                currentStudySection.classList.remove('hidden');
                document.getElementById('savedMaterialBox').innerText = appState.material;
                uploadDetails.removeAttribute('open');
            } else {
                currentStudySection.classList.add('hidden');
                uploadDetails.setAttribute('open', '');
            }

            currentTotalQuizzes = Math.min(10 + (appState.missedDays * 10), 30);
            penaltyCountEl.innerText = `${appState.missedDays * 10}ê°œ`;
            btnQuizCountEl.innerText = currentTotalQuizzes;

            updateProgressUI();
            
            if (appState.quizHistory.length >= 7 || appState.missedDays >= 7) {
                reportBtn.classList.remove('hidden');
            }
        }

        function updateProgressUI() {
            const history = appState.quizHistory;
            const daysStudied = history.length;
            let totalQ = 0, totalCorrect = 0;

            history.forEach(h => { totalQ += h.total; totalCorrect += h.score; });
            const accuracy = totalQ === 0 ? 0 : Math.round((totalCorrect / totalQ) * 100);
            const progressPercent = Math.min((daysStudied / 7) * 100, 100);

            document.getElementById('progDays').innerText = daysStudied;
            document.getElementById('progRate').innerText = accuracy;
            document.getElementById('progBar').style.width = `${progressPercent}%`;

            const progMessage = document.getElementById('progMessage');
            if (daysStudied === 0) progMessage.innerText = "ìƒˆë¡œìš´ í•™ìŠµ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤!";
            else if (daysStudied < 7) progMessage.innerText = `ì˜í•˜ê³  ìˆì–´ìš”! ${7 - daysStudied}ì¼ë§Œ ë” ì±„ì›Œë³´ì„¸ìš”.`;
            else {
                progMessage.innerText = "ğŸ‰ ì¼ì£¼ì¼ ëª©í‘œ ë‹¬ì„±! ì£¼ê°„ í‰ê°€ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
                progMessage.classList.add('text-emerald-400');
            }
        }

        // --- í…ìŠ¤íŠ¸ ì²˜ë¦¬ ë° ì—…ë¡œë“œ ì¸í„°ì…‰íŠ¸ (í•µì‹¬ ë³€ê²½!) ---
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading("â³ íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...");
            let rawText = "";

            try {
                const ext = file.name.split('.').pop().toLowerCase();
                if (file.type.startsWith('image/')) {
                    const result = await Tesseract.recognize(file, 'kor+eng');
                    rawText = result.data.text;
                } else if (ext === 'pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        rawText += textContent.items.map(item => item.str).join(' ') + " ";
                    }
                } else if (ext === 'docx' || ext === 'doc') {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                    rawText = result.value;
                } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                    rawText = XLSX.utils.sheet_to_csv(workbook.Sheets[workbook.SheetNames[0]]);
                } else {
                    rawText = await file.text();
                }

                if(rawText.trim().length < 5) throw new Error("í…ìŠ¤íŠ¸ ë¶€ì¡±");
                
                checkResetCondition(rawText);

            } catch (err) {
                hideLoading();
                alert("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì´ê±°ë‚˜ ê¹¨ì§„ íŒŒì¼ì…ë‹ˆë‹¤.");
            }
        };

        function processInput(type) {
            if(type === 'text') {
                const text = document.getElementById('textContent').value;
                if(!text.trim()) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                checkResetCondition(text);
            }
        }

        // [ì‹ ê·œ] ë¦¬ì…‹ ì¡°ê±´ ì²´í¬ ë° ì”ì†Œë¦¬ ëª¨ë‹¬ í˜¸ì¶œ
        async function checkResetCondition(rawText) {
            pendingNewRawText = rawText; // ì¼ë‹¨ ì„ì‹œ ì €ì¥

            // í’€ì—ˆë˜ ê¸°ë¡ì´ ì•„ì˜ˆ ì—†ë‹¤ë©´ ì”ì†Œë¦¬ ìƒëµí•˜ê³  ì¿¨í•˜ê²Œ ë°”ë¡œ ë¦¬ì…‹
            if (appState.quizHistory.length === 0) {
                confirmResetAndProcess();
                return;
            }

            // ê¸°ë¡ì´ ìˆë‹¤ë©´, í™˜ìŠ¹ ì”ì†Œë¦¬ ìƒì„±
            const key = apiKeyInput.value;
            if (!key) return alert("API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”!");
            localStorage.setItem('groq_key', key);

            showLoading("ğŸ‘¨â€ğŸ« ìƒˆ êµì¬ë¡œ ë„˜ì–´ê°€ê¸° ì „, ì´ì „ í•™ìŠµì„ í‰ê°€ ì¤‘ì…ë‹ˆë‹¤...");
            
            const historyText = appState.quizHistory.map(h => `- ${h.date}: ${h.total}ë¬¸ì œ ì¤‘ ${h.score}ê°œ ì •ë‹µ`).join('\n');
            const systemPrompt = `ë‹¹ì‹ ì€ ì—„ê²©í•œ í˜¸ë‘ì´ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒ(ë² íŠ¸ë‚¨ì¸)ì´ ì§€ê¸ˆ ë°°ìš°ë˜ êµì¬ë¥¼ ë²„ë¦¬ê³  ìƒˆ êµì¬ë¡œ ë„˜ì–´ê°€ë ¤ í•©ë‹ˆë‹¤.
ì´ì „ êµì¬ì˜ í•™ìŠµ ê¸°ë¡(ê²°ì„ ì¼ìˆ˜, ì„±ì )ì„ ë°”íƒ•ìœ¼ë¡œ 'ë² íŠ¸ë‚¨ì–´'ë¡œ íŒ©í­ ì”ì†Œë¦¬ì™€ ìƒˆ êµì¬ í•™ìŠµì— ëŒ€í•œ ê¶Œì¥ ì§€ì¹¨ì„ 1000ì ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. 
í˜¼ë‚´ë©´ì„œë„ ê²°êµ­ì—” ì˜ í•´ë³´ìëŠ” ê²©ë ¤ë¡œ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: `ê²°ì„ ëˆ„ì : ${appState.missedDays}ì¼\nì´ì „ í•™ìŠµ ì„±ì :\n${historyText}` }],
                        temperature: 0.7 
                    })
                });

                const data = await res.json();
                hideLoading();
                
                // ëª¨ë‹¬ ë„ìš°ê¸°
                document.getElementById('closingReportText').innerText = data.choices[0].message.content;
                document.getElementById('closingModal').classList.remove('hidden');

            } catch (err) {
                hideLoading();
                alert("í‰ê°€ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ë°”ë¡œ ë¦¬ì…‹ì„ ì§„í–‰í• ê¹Œìš”?");
                confirmResetAndProcess();
            }
        }

        // ì·¨ì†Œ ë²„íŠ¼
        function cancelReset() {
            document.getElementById('closingModal').classList.add('hidden');
            pendingNewRawText = "";
            alert("ìƒˆ êµì¬ ë“±ë¡ì„ ì·¨ì†Œí•˜ê³  ê¸°ì¡´ êµì¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.");
        }

        // ì”ì†Œë¦¬ í™•ì¸ í›„ ì§„ì§œë¡œ ë¦¬ì…‹ & AI ìš”ì•½ ì§„í–‰
        async function confirmResetAndProcess() {
            document.getElementById('closingModal').classList.add('hidden');
            const key = apiKeyInput.value;
            
            showLoading("ğŸ¤– ìƒˆ êµì¬ì˜ í•µì‹¬ ë‚´ìš©ì„ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

            const systemPrompt = `ë‹¹ì‹ ì€ ì¡±ì§‘ê²Œ í•œêµ­ì–´ ê°•ì‚¬ì…ë‹ˆë‹¤. ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì˜ ì˜¤íƒ€ë¥¼ ë¬´ì‹œí•˜ê³ , 
ì´ í…ìŠ¤íŠ¸ì—ì„œ í•™ìƒì´ ë°°ì›Œì•¼ í•  'í•µì‹¬ í•œêµ­ì–´ ë‹¨ì–´(ì–´íœ˜)', 'ì¤‘ìš” ë¬¸ë²•', 'í•µì‹¬ íšŒí™” í‘œí˜„'ì„ êµ¬ì²´ì ìœ¼ë¡œ ì¶”ì¶œí•˜ì„¸ìš”.
ì ˆëŒ€ "ì´ ê¸€ì€ í•œêµ­ì–´ í•™ìŠµ ë‚´ìš©ì…ë‹ˆë‹¤" ê°™ì€ ì“¸ë°ì—†ëŠ” ë©”íƒ€ ì„¤ëª…ì„ í•˜ì§€ ë§ˆì„¸ìš”.
ê²°ê³¼ëŠ” í•´ë‹¹ ë‹¨ì–´/ë¬¸ë²•ë“¤ê³¼ ê·¸ì— ëŒ€í•œ ë² íŠ¸ë‚¨ì–´ ëœ»ìœ¼ë¡œ ì •ë¦¬í•˜ì—¬ 4~5ì¤„ë¡œ ìš”ì•½í•˜ì„¸ìš”. (JSON ê¸ˆì§€)`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: pendingNewRawText.substring(0, 3000) }],
                        temperature: 0.3
                    })
                });
                
                const data = await res.json();
                
                // --- ì§„ì§œ ë¦¬ì…‹ ---
                appState.material = data.choices[0].message.content;
                appState.missedDays = 0;
                appState.quizHistory = [];
                appState.lastLoginDate = new Date().toDateString();
                saveState();
                
                hideLoading();
                document.getElementById('naggingSection').classList.add('hidden'); // ê¸°ì¡´ ì”ì†Œë¦¬ ìˆ¨ê¹€
                document.getElementById('quizContainer').innerHTML = ''; // ê¸°ì¡´ í€´ì¦ˆ ë‚ ë¦¼
                pendingNewRawText = "";
                
                alert("âœ… ì„±ê³µì ìœ¼ë¡œ ìƒˆ êµì¬ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ì§„í–‰ë„ê°€ 0%ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                initApp(); 

            } catch (err) {
                hideLoading();
                alert("ìƒˆ êµì¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // --- í€´ì¦ˆ ìƒì„± ë¡œì§ ---
        async function generateQuiz() {
            const key = apiKeyInput.value;
            if (!key) return alert("API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”!");

            const genBtn = document.getElementById('genBtn');
            genBtn.innerText = `ğŸ‘¨â€ğŸ« ${currentTotalQuizzes}ë¬¸ì œ ì¶œì œ ì¤‘... â³`;
            genBtn.disabled = true;
            document.getElementById('quizContainer').innerHTML = '';
            scoreCounter = 0;

            const systemPrompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë¬´ì„œìš´ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.

[â˜…ìµœê³ ì˜ í€„ë¦¬í‹°ë¥¼ ìœ„í•œ ì¶œì œ ì§€ì¹¨â˜…]
1. ë©”íƒ€ í…ìŠ¤íŠ¸ ê¸ˆì§€: "í•™ìŠµ ìš”ì•½ë³¸ ì½ê¸°", "êµì¬ ë³´ê¸°", "ì •ë‹µ ê³ ë¥´ê¸°" ê°™ì€ ì˜ì–‘ê°€ ì—†ëŠ” ë³´ê¸°ë¥¼ ì ˆëŒ€ ë‚´ì§€ ë§ˆì„¸ìš”.
2. í•µì‹¬ ê³µëµ: ì œê³µëœ ìš”ì•½ë³¸ì— ìˆëŠ” 'ì‹¤ì œ í•œêµ­ì–´ ë‹¨ì–´, ë¬¸ë²•, íšŒí™” í‘œí˜„'ì„ í™œìš©í•˜ì—¬ ì‹¤ì „ ë¬¸ì œë¥¼ ë§Œë“œì„¸ìš”. (ì˜ˆ: ê°€êµ¬ ë‹¨ì›ì´ë©´ ì±…ìƒ, ì˜ì, ì¹¨ëŒ€ ë“±ì˜ ë‹¨ì–´ë¥¼ í™œìš©)
3. ì˜¤ë‹µ(Distractors)ì˜ ì§ˆ: ì •ë‹µê³¼ í—·ê°ˆë¦´ ë§Œí•œ, ì‹¤ì œë¡œ í•œêµ­ì–´ í•™ìŠµìë“¤ì´ ìì£¼ í‹€ë¦¬ëŠ” ê·¸ëŸ´ì‹¸í•œ í•œêµ­ì–´ ë‹¨ì–´ë‚˜ ë¬¸ì¥ì„ ì˜¤ë‹µ ë³´ê¸°ë¡œ êµ¬ì„±í•˜ì„¸ìš”.
4. ìƒí™© ëŒ€ì²˜, ë¹ˆì¹¸ ì±„ìš°ê¸°, ì˜ë„ íŒŒì•… 3ê°€ì§€ ìœ í˜•ì„ ì„ì–´ì„œ ë¬´ì¡°ê±´ 'ì •í™•íˆ ${currentTotalQuizzes}ë¬¸ì œ' ì¶œì œ.

[â˜…ì–¸ì–´ ë¶„ë¦¬ ì ˆëŒ€ ê·œì¹™ (CRITICAL)â˜…]
1. q_vn: 100% ë² íŠ¸ë‚¨ì–´ë¡œ ì§ˆë¬¸ (ë¹ˆì¹¸ ë¬¸ì œì¼ ê²½ìš°ì—ë§Œ í•œêµ­ì–´ ì§€ë¬¸ í¬í•¨)
2. options_korean_only: â˜…100% í•œêµ­ì–´ë¡œë§Œ ì‘ì„±â˜… (ë² íŠ¸ë‚¨ì–´ ì ˆëŒ€ ê¸ˆì§€, 4ê°œ ë³´ê¸°)
3. exp: 100% ë² íŠ¸ë‚¨ì–´ë¡œ ì™œ ì •ë‹µì´ê³  ì™œ ì˜¤ë‹µì¸ì§€ ìƒì„¸íˆ í•´ì„¤ ì‘ì„±

[JSON êµ¬ì¡°]
{ "questions": [ { "q_vn": "...", "options_korean_only": ["í•œêµ­ì–´","í•œêµ­ì–´","í•œêµ­ì–´","í•œêµ­ì–´"], "a": 0, "exp": "..." } ] }`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: `í•™ìŠµ ìš”ì•½ë³¸: ${appState.material}` }],
                        response_format: { type: "json_object" },
                        temperature: 0.4, // ë°”ë³´ ë°©ì§€ë¥¼ ìœ„í•´ 0.2ì—ì„œ 0.4ë¡œ ì •ìƒí™”. (ì§€ëŠ¥ ë³µêµ¬!)
                        max_tokens: 8000
                    })
                });

                const data = await res.json();
                const json = JSON.parse(data.choices[0].message.content);
                renderQuiz(json.questions);
            } catch (err) {
                alert("ì¶œì œ ì˜¤ë¥˜ ë°œìƒ!");
            } finally {
                genBtn.innerText = `ğŸš€ ì´ ${currentTotalQuizzes}ë¬¸ì œ ì¶œì œ ë° í’€ê¸°`;
                genBtn.disabled = false;
            }
        }

        function renderQuiz(questions) {
            const container = document.getElementById('quizContainer');
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                let optionsHtml = q.options_korean_only.map((opt, oIdx) => `
                    <button onclick="handleAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}', ${questions.length})" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 mb-2 font-medium">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');
                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-emerald-100">${qIdx + 1}. ${q.q_vn}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-4 rounded-xl bg-slate-900 border-l-4 border-emerald-500 text-slate-300"></div>
                `;
                container.appendChild(qDiv);
            });
        }

        function handleAnswer(btn, qIdx, selected, correct, explanation, totalQ) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            optionsDiv.querySelectorAll('button').forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-emerald-400 text-base">âœ… <strong>ChÃ­nh xÃ¡c!</strong></span><br><br>${explanation}`;
                scoreCounter++;
            } else {
                btn.classList.add('wrong');
                optionsDiv.querySelectorAll('button')[correct].classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-red-400 text-base">âŒ <strong>Sai rá»“i!</strong></span><br><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');

            if (document.querySelectorAll('.correct, .wrong').length === totalQ) {
                appState.quizHistory.push({ date: new Date().toDateString(), score: scoreCounter, total: totalQ });
                appState.missedDays = 0;
                appState.lastLoginDate = new Date().toDateString(); 
                saveState();
                
                setTimeout(() => {
                    alert(`ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ì´ ${totalQ}ë¬¸ì œ ì¤‘ ${scoreCounter}ë¬¸ì œ ì •ë‹µ!\nì§„í–‰ë„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    initApp(); 
                    document.getElementById('quizContainer').innerHTML = ''; 
                }, 1000);
            }
        }

        // ì¼ë°˜ ì£¼ê°„ ì„±ì í‘œ (V5ì™€ ë™ì¼)
        async function generateWeeklyReport() {
            const key = apiKeyInput.value;
            const btn = document.getElementById('reportBtn');
            btn.innerText = "ğŸ¤¬ ì„ ìƒë‹˜ì´ ì”ì†Œë¦¬ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤... â³";
            btn.disabled = true;

            const historyText = appState.quizHistory.map(h => `- ${h.date}: ${h.total}ë¬¸ì œ ì¤‘ ${h.score}ê°œ ì •ë‹µ`).join('\n');
            const systemPrompt = `ë‹¹ì‹ ì€ ì—„ê²©í•œ í˜¸ë‘ì´ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.
í•™ìƒì˜ ì¼ì£¼ì¼ì¹˜ ì„±ì í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ë² íŠ¸ë‚¨ì–´'ë¡œ 1000ì ì´ìƒì˜ íŒ©í­ ì§„ë‹¨ ë° ì¡°ì–¸ì„ ì‘ì„±í•˜ì„¸ìš”.`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: `ê²°ì„ ëˆ„ì : ${appState.missedDays}ì¼\nì„±ì  íˆìŠ¤í† ë¦¬:\n${historyText}` }],
                        temperature: 0.7 
                    })
                });

                const data = await res.json();
                document.getElementById('naggingSection').classList.remove('hidden');
                document.getElementById('naggingText').innerText = data.choices[0].message.content;
                
                if(confirm("ì”ì†Œë¦¬ë¥¼ í™•ì¸í•˜ì…¨ë‚˜ìš”? ì´ë²ˆ ì£¼ í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.")) {
                    appState.quizHistory = [];
                    appState.missedDays = 0;
                    saveState();
                    initApp();
                }
            } catch (err) { alert("ì˜¤ë¥˜ ë°œìƒ!"); } 
            finally { btn.innerText = "ğŸ“Š ì¼ì£¼ì¼ í‰ê°€ & ì”ì†Œë¦¬ ë“£ê¸° (1000ì)"; btn.disabled = false; }
        }

        function showLoading(msg) { document.getElementById('loadingStatus').innerText = msg; document.getElementById('loadingStatus').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingStatus').classList.add('hidden'); }
        function simulateNextDay() {
            appState.lastLoginDate = new Date(new Date().getTime() - (24 * 60 * 60 * 1000)).toDateString(); 
            saveState(); location.reload();
        }

        initApp();
    </script>
</body>
</html>
