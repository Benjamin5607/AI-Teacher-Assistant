<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v5.0.2/dist/tesseract.min.js'></script>
    <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR ğŸ“</h1>
            <p class="text-slate-400 text-sm">For My Vietnamese Student</p>
        </header>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">âš™ï¸ API Settings</summary>
            <div class="p-4">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm focus:border-emerald-500 focus:outline-none">
            </div>
        </details>

        <section class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
            <label class="block cursor-pointer group">
                <div class="bg-emerald-600 group-hover:bg-emerald-500 p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg">
                    <span>ğŸ“¸ 1. êµì¬ ì‚¬ì§„ ì°ê¸°</span>
                </div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
            </label>
            <div id="status" class="text-center text-xs mt-3 text-emerald-400 font-medium font-bold">êµì¬ ì‚¬ì§„ì„ ì°ì–´ì£¼ì„¸ìš”!</div>
        </section>

        <details class="bg-slate-800 rounded-xl border border-slate-700" open>
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">ğŸ“ 2. ì¶”ì¶œëœ í…ìŠ¤íŠ¸ í™•ì¸ ë° í€´ì¦ˆ ìƒì„±</summary>
            <div class="p-4 space-y-4">
                <textarea id="rawContent" rows="4" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500" placeholder="ì¶”ì¶œëœ ê¸€ìê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ì˜¤íƒ€ê°€ ìˆë‹¤ë©´ ì‚´ì§ ìˆ˜ì •í•´ì£¼ì„¸ìš”!"></textarea>
                <button onclick="generateQuiz()" id="genBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold transition-all disabled:opacity-50 text-white shadow-lg">
                    ğŸš€ 3. ì´ ë‚´ìš©ìœ¼ë¡œ 10ë¬¸ì œ ì¶œì œí•˜ê¸°
                </button>
            </div>
        </details>

        <div id="quizContainer" class="space-y-6 pb-10"></div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const rawContent = document.getElementById('rawContent');
        const quizContainer = document.getElementById('quizContainer');
        const genBtn = document.getElementById('genBtn');

        // í‚¤ ìë™ ë¡œë“œ
        document.getElementById('apiKey').value = localStorage.getItem('groq_key') || '';

        // 1. ì‚¬ì§„ ì´¬ì˜ ë° OCR (ìë™ í€´ì¦ˆ ìƒì„± ì œê±° -> ìœ ì €ê°€ í…ìŠ¤íŠ¸ í™•ì¸ í›„ ë²„íŠ¼ ëˆ„ë¥´ë„ë¡)
        imageInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "â³ ê¸€ìë¥¼ ì½ëŠ” ì¤‘... (Äang Ä‘á»c chá»¯...)";
            rawContent.value = "ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";
            try {
                const result = await Tesseract.recognize(file, 'kor+eng');
                rawContent.value = result.data.text;
                status.innerText = "âœ… ì½ê¸° ì™„ë£Œ! ê¸€ìë¥¼ í™•ì¸í•˜ê³  ì•„ë˜ ì¶œì œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            } catch (err) {
                status.innerText = "âŒ ì—ëŸ¬ ë°œìƒ!";
                rawContent.value = "";
            }
        };

        // 2. Groq API í˜¸ì¶œ (40ë…„ ë² í…Œë‘ ê°•ì‚¬ ëª¨ë“œ V3 - ì—„ê²©í•œ ë£° ì ìš©)
        async function generateQuiz() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('groq_key', key);
            
            const content = rawContent.value;
            if (!key || !content.trim()) {
                alert("API í‚¤ì™€ í…ìŠ¤íŠ¸ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤!");
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            genBtn.innerText = "ğŸ‘¨â€ğŸ« 40ë…„ ë² í…Œë‘ ê°•ì‚¬ê°€ ë¬¸ì œ ì—„ì„  ì¤‘... â³";
            genBtn.disabled = true;
            status.innerText = "ë¬¸ì œ ì¶œì œ ì¤‘ì…ë‹ˆë‹¤...";
            quizContainer.innerHTML = '';

            // [í•µì‹¬ ë³€ê²½] í™˜ê° ë°©ì§€, 10ë¬¸ì œ ê°•ì œ, ì˜ì–´ ì•ŒíŒŒë²³ ê¸ˆì§€ë¥¼ ì´˜ì´˜íˆ ì—®ì€ í”„ë¡¬í”„íŠ¸
            const systemPrompt = `ë‹¹ì‹ ì€ 40ë…„ ê²½ë ¥ì˜ ë² í…Œë‘ í•œêµ­ì–´ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì€ ë² íŠ¸ë‚¨ì¸ì…ë‹ˆë‹¤.
ì•„ë˜ì˜ [ì ˆëŒ€ ê·œì¹™]ì„ ë¬´ì¡°ê±´ ì§€í‚¤ì„¸ìš”. ì–´ê¸¸ ì‹œ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

[ì ˆëŒ€ ê·œì¹™]
1. ì–¸ì–´ ì œí•œ: ì˜¤ì§ 'í•œêµ­ì–´'ì™€ 'ë² íŠ¸ë‚¨ì–´'ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
2. ë°œìŒ ê¸°í˜¸ ê¸ˆì§€: í•œêµ­ì–´ë¥¼ ì˜ì–´ ì•ŒíŒŒë²³(Romanization)ìœ¼ë¡œ í‘œê¸°í•˜ëŠ” ê²ƒì„ 'ì ˆëŒ€ ê¸ˆì§€'í•©ë‹ˆë‹¤. (ì˜ˆ: Annyeonghaseyo ê¸ˆì§€). íƒœêµ­ì–´ë‚˜ ì•„ëì–´ë„ ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš”.
3. ë¬¸í•­ ìˆ˜: ë¬´ì¡°ê±´ 'ì •í™•íˆ 10ë¬¸ì œ'ë¥¼ ì¶œì œí•´ì•¼ í•©ë‹ˆë‹¤.
4. ì¶œì œ ë°©ì‹: ë³¸ë¬¸ì„ ë‹¨ìˆœ ë³µì‚¬í•˜ì§€ ë§ê³ , í…ìŠ¤íŠ¸ì˜ ìƒí™©ì„ ìœ ì¶”í•˜ì—¬ ì‹¤ì „ íšŒí™”, ë¬¸ë²•, ì–´íœ˜ ì‘ìš©ë¬¸ì œë¥¼ ë§Œë“œì„¸ìš”.
5. í•´ì„¤(exp): ë² íŠ¸ë‚¨ì–´ë¡œ ì‘ì„±í•˜ë©°, ì™œ ì •ë‹µì¸ì§€ í•œêµ­ ë¬¸í™”ë‚˜ ë‰˜ì•™ìŠ¤ ì°¨ì´ëŠ” ë¬´ì—‡ì¸ì§€ 40ë…„ ë² í…Œë‘ì˜ íŒì„ ë‹´ì•„ ìƒì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”.

[JSON êµ¬ì¡° ê°€ì´ë“œ]
{
  "questions": [
    {
      "q": "ìƒí™© ì œì‹œí˜• ì§ˆë¬¸ (í•œêµ­ì–´ + ë² íŠ¸ë‚¨ì–´ ëœ» ë³‘ê¸°)",
      "options": ["í•œêµ­ì–´ ë³´ê¸° 1", "í•œêµ­ì–´ ë³´ê¸° 2", "í•œêµ­ì–´ ë³´ê¸° 3", "í•œêµ­ì–´ ë³´ê¸° 4"],
      "a": 0,
      "exp": "ë² íŠ¸ë‚¨ì–´ í•´ì„¤ (ì•ŒíŒŒë²³ ë°œìŒ í‘œê¸° ì ˆëŒ€ ê¸ˆì§€)"
    }
  ]
}`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `ì˜¤ëŠ˜ì˜ êµì¬ ë‚´ìš©ì´ë‹¤. ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì˜ì–´ ë°œìŒ í‘œê¸° ì—†ì´ ì •í™•íˆ 10ë¬¸ì œë¥¼ ë‚´ê±°ë¼: ${content}` }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.5, // í™˜ê°(ì—‰ëš±í•œ ì–¸ì–´)ì„ ì¤„ì´ê³  ì •ì„ì ì¸ ë‹µë³€ì„ ìœ„í•´ 0.7ì—ì„œ 0.5ë¡œ í•˜í–¥
                        max_tokens: 6000  // 10ë¬¸ì œ ë°ì´í„°ê°€ ì¤‘ê°„ì— ì˜ë¦¬ì§€ ì•Šë„ë¡ í† í° ìµœëŒ€ì¹˜ ë„‰ë„‰í•˜ê²Œ í™•ë³´
                    })
                });

                const data = await res.json();
                
                if (data.choices && data.choices[0].message.content) {
                    const json = JSON.parse(data.choices[0].message.content);
                    
                    // ë¬¸í•­ ìˆ˜ ì²´í¬ ë¡œì§ ì¶”ê°€
                    if (json.questions.length < 10) {
                        status.innerText = `âš ï¸ 10ê°œ ì¤‘ ${json.questions.length}ê°œë§Œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í•œ ë²ˆ ë” ì¶œì œ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.`;
                    } else {
                        status.innerText = "âœ¨ ë² í…Œë‘ ê°•ì‚¬ì˜ ì¡±ì§‘ê²Œ 10ë¬¸ì œ ì™„ì„±!";
                    }
                    
                    renderQuiz(json.questions);
                } else {
                    throw new Error("Invalid API Response");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                alert("AI ì¶œì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                // ë²„íŠ¼ ì›ìƒë³µêµ¬
                genBtn.innerText = "ğŸš€ ì´ ë‚´ìš©ìœ¼ë¡œ 10ë¬¸ì œ ì¶œì œí•˜ê¸°";
                genBtn.disabled = false;
            }
        }

        // 3. í€´ì¦ˆ ì•± í™”ë©´ ë Œë”ë§
        function renderQuiz(questions) {
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                
                let optionsHtml = q.options.map((opt, oIdx) => `
                    <button onclick="checkAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}')" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 transition-all text-sm mb-2">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');

                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-emerald-100">${qIdx + 1}. ${q.q}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-4 rounded-xl bg-slate-900 border-l-4 border-emerald-500 text-slate-300 leading-relaxed shadow-inner"></div>
                `;
                quizContainer.appendChild(qDiv);
            });
        }

        // 4. ì •ë‹µ ì²´í¬ ë° í”¼ë“œë°±
        function checkAnswer(btn, qIdx, selected, correct, explanation) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            const buttons = optionsDiv.querySelectorAll('button');

            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-emerald-400 text-base">âœ… <strong>ChÃ­nh xÃ¡c! (ì •ë‹µ!)</strong></span><br><br>${explanation}`;
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-red-400 text-base">âŒ <strong>Sai rá»“i! (í‹€ë ¸ì–´ìš”!)</strong></span><br><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
