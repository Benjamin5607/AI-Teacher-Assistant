<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v5.0.2/dist/tesseract.min.js'></script>
    <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR ğŸ“</h1>
            <p class="text-slate-400 text-sm">For My Vietnamese Student</p>
        </header>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">API Settings</summary>
            <div class="p-4">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm">
            </div>
        </details>

        <section class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
            <label class="block cursor-pointer group">
                <div class="bg-emerald-600 group-hover:bg-emerald-500 p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                    <span>ğŸ“¸ ì‚¬ì§„ ì°ê³  í€´ì¦ˆ ë§Œë“¤ê¸°</span>
                </div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
            </label>
            <div id="status" class="text-center text-xs mt-3 text-slate-500 font-medium">êµì¬ ì‚¬ì§„ì„ ì°ì–´ì£¼ì„¸ìš”!</div>
        </section>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">Edit Extracted Text</summary>
            <textarea id="rawContent" rows="3" class="w-full bg-slate-900 border-none p-3 text-sm text-slate-400"></textarea>
        </details>

        <div id="quizContainer" class="space-y-6"></div>
        
        <div id="analysisResult" class="hidden bg-blue-900/40 p-6 rounded-2xl border border-blue-500/30">
            <h3 class="text-xl font-bold text-blue-300 mb-2">ğŸ“Š Weekly Analysis Guide</h3>
            <div id="analysisText" class="text-sm text-slate-300 leading-relaxed"></div>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const rawContent = document.getElementById('rawContent');
        const quizContainer = document.getElementById('quizContainer');

        // í‚¤ ìë™ ë¡œë“œ
        document.getElementById('apiKey').value = localStorage.getItem('groq_key') || '';

        // 1. ì‚¬ì§„ ì´¬ì˜ ë° OCR
        imageInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "â³ ê¸€ìë¥¼ ì½ëŠ” ì¤‘... (Äang Ä‘á»c chá»¯...)";
            try {
                const result = await Tesseract.recognize(file, 'kor+eng');
                rawContent.value = result.data.text;
                status.innerText = "âœ… ì½ê¸° ì™„ë£Œ! í€´ì¦ˆë¥¼ ìƒì„±í•©ë‹ˆë‹¤...";
                generateQuiz(); // í…ìŠ¤íŠ¸ ì½ìë§ˆì í€´ì¦ˆ ìƒì„± ìë™ ì‹¤í–‰
            } catch (err) {
                status.innerText = "âŒ ì—ëŸ¬ ë°œìƒ!";
            }
        };

        // 2. Groq API í˜¸ì¶œ (40ë…„ ë² í…Œë‘ ê°•ì‚¬ ëª¨ë“œ)
        async function generateQuiz() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('groq_key', key);
            
            const content = rawContent.value;
            if (!key || !content) return;

            status.innerText = "ğŸ‘¨â€ğŸ« 40ë…„ ê²½ë ¥ ë² í…Œë‘ ê°•ì‚¬ê°€ ë¬¸ì œë¥¼ ë¶„ì„ ì¤‘...";
            quizContainer.innerHTML = '';

            // í˜ë¥´ì†Œë‚˜ì™€ ì¶œì œ ì§€ì¹¨ì„ ê°•í™”í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
            const systemPrompt = `ë‹¹ì‹ ì€ ì™¸êµ­ì¸ì—ê²Œ í•œêµ­ì–´ë¥¼ 40ë…„ ë™ì•ˆ ê°€ë¥´ì³ì˜¨ 'ë² í…Œë‘ í•œêµ­ì–´ ê°•ì‚¬'ì…ë‹ˆë‹¤.
ì£¼ì–´ì§„ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬, í•™ìƒì´ ë‹¨ìˆœíˆ ë‹¨ì–´ë¥¼ ì™¸ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë¬¸ë§¥ê³¼ í•œêµ­ì–´ì˜ ë¯¸ë¬˜í•œ ì°¨ì´ë¥¼ ê¹¨ë‹«ê²Œ í•˜ëŠ” 'ìµœê³ ì˜ 10ë¬¸ì œ'ë¥¼ ë§Œë“œì„¸ìš”.

[ì¶œì œ ì§€ì¹¨]
1. ë¶„ì„ì  ì¶œì œ: ë‹¨ìˆœ ë³µì‚¬ê°€ ì•„ë‹ˆë¼, í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ë¬¸ë²•ê³¼ ë² íŠ¸ë‚¨ì¸ì´ ìì£¼ í‹€ë¦¬ëŠ” ì¡°ì‚¬/ì–´ë¯¸ë¥¼ ê³µëµí•˜ì„¸ìš”.
2. ì‹¤ì „ ë‰˜ì•™ìŠ¤: í•œêµ­ì¸ì´ ì‹¤ìƒí™œì—ì„œ ì‚¬ìš©í•˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í‘œí˜„ ìœ„ì£¼ë¡œ ì§ˆë¬¸ì„ êµ¬ì„±í•˜ì„¸ìš”.
3. ì¹œì ˆí•œ ë² í…Œë‘: í•´ì„¤(exp)ì€ ë² íŠ¸ë‚¨ì–´ë¡œ ì‘ì„±í•˜ë˜, 40ë…„ ë‚´ê³µì´ ëŠê»´ì§€ëŠ” ê¹Šì´ ìˆëŠ” ì¡°ì–¸ì„ ë‹´ì•„ì£¼ì„¸ìš”.
4. ëª¨ë“  ì§ˆë¬¸(q)ì€ í•œêµ­ì–´ ì§ˆë¬¸ ë’¤ì— ë² íŠ¸ë‚¨ì–´ ëœ»ì„ ê´„í˜¸ ì•ˆì— ë³‘ê¸°í•˜ì„¸ìš”.

[JSON í˜•ì‹]
{ "questions": [{ "q": "ì§ˆë¬¸ (ì˜ë¯¸)", "options": ["1","2","3","4"], "a": 0, "exp": "ë² íŠ¸ë‚¨ì–´ë¡œ ëœ ë² í…Œë‘ì˜ ì¡±ì§‘ê²Œ í•´ì„¤" }] }`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `ì˜¤ëŠ˜ì˜ êµì¬ ë‚´ìš©ì´ë‹¤. ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìµœê³ ì˜ ë¬¸ì œë¥¼ ë‚´ê±°ë¼: ${content}` }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.7, // ì•½ê°„ì˜ ì°½ì˜ì„±ì„ ì£¼ì–´ ë” ì¢‹ì€ ë¬¸ì œë¥¼ ë‚´ê²Œ í•¨
                        max_tokens: 4096
                    })
                });

                const data = await res.json();
                
                // Groq API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ì•ˆì „í•˜ê²Œ íŒŒì‹±
                if (data.choices && data.choices[0].message.content) {
                    const json = JSON.parse(data.choices[0].message.content);
                    renderQuiz(json.questions);
                    status.innerText = "âœ¨ ë² í…Œë‘ ê°•ì‚¬ì˜ ì¡±ì§‘ê²Œ í€´ì¦ˆ ì™„ì„±!";
                } else {
                    throw new Error("Invalid API Response");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "âŒ í€´ì¦ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ! (API í‚¤ë‚˜ ëª¨ë¸ í™•ì¸)";
            }
        }

        // 3. í€´ì¦ˆ ì•± í™”ë©´ ë Œë”ë§
        function renderQuiz(questions) {
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                
                let optionsHtml = q.options.map((opt, oIdx) => `
                    <button onclick="checkAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}')" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 transition-all text-sm mb-2">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');

                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-4 text-emerald-100">${qIdx + 1}. ${q.q}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-3 rounded-lg bg-slate-900 border-l-4 border-emerald-500 text-slate-300"></div>
                `;
                quizContainer.appendChild(qDiv);
            });
        }

        // 4. ì •ë‹µ ì²´í¬ ë° í”¼ë“œë°±
        function checkAnswer(btn, qIdx, selected, correct, explanation) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            const buttons = optionsDiv.querySelectorAll('button');

            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `âœ… <strong>ChÃ­nh xÃ¡c! (ì •ë‹µ!)</strong><br>${explanation}`;
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
                feedbackDiv.innerHTML = `âŒ <strong>Sai rá»“i! (í‹€ë ¸ì–´ìš”!)</strong><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
