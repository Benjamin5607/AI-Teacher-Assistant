<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teacher Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v5.0.2/dist/tesseract.min.js'></script>
    <style>
        .correct { background-color: #10b981 !important; color: white; border-color: #10b981; }
        .wrong { background-color: #ef4444 !important; color: white; border-color: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-md mx-auto p-6 space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-black text-emerald-400">K-TUTOR 🎓</h1>
            <p class="text-slate-400 text-sm">For My Vietnamese Student</p>
        </header>

        <details class="bg-slate-800 rounded-xl border border-slate-700">
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">⚙️ API Settings</summary>
            <div class="p-4">
                <input type="password" id="apiKey" placeholder="Groq API Key" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-sm focus:border-emerald-500 focus:outline-none">
            </div>
        </details>

        <section class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
            <label class="block cursor-pointer group">
                <div class="bg-emerald-600 group-hover:bg-emerald-500 p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg">
                    <span>📸 1. 교재 사진 찍기</span>
                </div>
                <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
            </label>
            <div id="status" class="text-center text-xs mt-3 text-emerald-400 font-medium font-bold">교재 사진을 찍어주세요!</div>
        </section>

        <details class="bg-slate-800 rounded-xl border border-slate-700" open>
            <summary class="p-3 text-xs text-slate-500 cursor-pointer">📝 2. 추출된 텍스트 확인 및 퀴즈 생성</summary>
            <div class="p-4 space-y-4">
                <textarea id="rawContent" rows="4" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm text-slate-300 focus:outline-none focus:border-emerald-500" placeholder="추출된 글자가 나타납니다. 오타가 있다면 살짝 수정해주세요!"></textarea>
                <button onclick="generateQuiz()" id="genBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-xl font-bold transition-all disabled:opacity-50 text-white shadow-lg">
                    🚀 3. 실전 어학 10문제 출제하기
                </button>
            </div>
        </details>

        <div id="quizContainer" class="space-y-6 pb-10"></div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const rawContent = document.getElementById('rawContent');
        const quizContainer = document.getElementById('quizContainer');
        const genBtn = document.getElementById('genBtn');

        // 키 자동 로드
        document.getElementById('apiKey').value = localStorage.getItem('groq_key') || '';

        // 1. 사진 촬영 및 OCR 
        imageInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "⏳ 글자를 읽는 중... (Đang đọc chữ...)";
            rawContent.value = "이미지를 분석하고 있습니다. 잠시만 기다려주세요...";
            try {
                const result = await Tesseract.recognize(file, 'kor+eng');
                rawContent.value = result.data.text;
                status.innerText = "✅ 읽기 완료! 글자를 확인하고 아래 출제 버튼을 눌러주세요.";
            } catch (err) {
                status.innerText = "❌ 에러 발생!";
                rawContent.value = "";
            }
        };

        // 2. Groq API 호출 (사용자 맞춤형 언어 분리 프롬프트)
        async function generateQuiz() {
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('groq_key', key);
            
            const content = rawContent.value;
            if (!key || !content.trim()) {
                alert("API 키와 텍스트 내용이 필요합니다!");
                return;
            }

            genBtn.innerText = "👨‍🏫 40년 베테랑 강사가 문제 엄선 중... ⏳";
            genBtn.disabled = true;
            status.innerText = "문제 출제 중입니다...";
            quizContainer.innerHTML = '';

            // [핵심 변경] 베트남어 메인 질문 -> 한국어 서브 질문 -> 한국어 보기
            const systemPrompt = `당신은 40년 경력의 베테랑 한국어 교사입니다. 학생은 베트남인입니다.
아래의 [출제 유형] 3가지 중 하나를 골라, 총 10문제를 구성하세요. 본문을 그대로 복사하는 것은 절대 금지입니다.

[출제 유형 - 이 3가지 외에는 출제 불가]
1. 상황에 맞는 문장 찾기: 베트남어로 상황을 설명하고, 그 상황에 맞는 한국어 대사를 고르게 하세요.
2. 빈칸 채우기: 베트남어로 문맥을 설명하고, 빈칸(____)이 있는 한국어 문장을 제시한 뒤 알맞은 한국어 단어/동사를 고르게 하세요.
3. 문장의 의도 파악: 한국어 문장을 제시하고, 이 문장이 어떤 상황에 쓰이는지 한국어로 설명된 보기를 고르게 하세요. (질문은 베트남어로)

[언어 및 형식 절대 규칙]
1. q_vn(메인 질문): 반드시 '베트남어'로만 상황이나 문제를 설명하세요.
2. q_kr(서브 질문): 위 베트남어 질문의 '한국어 번역'이거나, 빈칸이 뚫린 '한국어 지문'을 넣으세요.
3. options(보기): 4개의 보기는 무조건 100% '한국어'로만 작성하세요. 베트남어 힌트 금지.
4. 금지어: 태국어, 아랍어, 영어, 발음 기호(Romanization) 절대 사용 금지.
5. 문항 수: 무조건 정확히 10문제.
6. exp(해설): 베트남어로 상세히 설명하세요.

[JSON 구조 가이드]
{
  "questions": [
    {
      "q_vn": "베트남어로 된 메인 질문 및 상황 설명",
      "q_kr": "한국어로 번역된 질문 또는 빈칸이 포함된 한국어 지문",
      "options": ["한국어 보기 1", "한국어 보기 2", "한국어 보기 3", "한국어 보기 4"],
      "a": 0,
      "exp": "베트남어 해설"
    }
  ]
}`;

            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: `오늘의 교재 내용이다. 이 내용을 바탕으로 영어 발음 표기 없이 정확히 10문제를 내거라: ${content}` }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.4, 
                        max_tokens: 6000
                    })
                });

                const data = await res.json();
                
                if (data.choices && data.choices[0].message.content) {
                    const json = JSON.parse(data.choices[0].message.content);
                    
                    if (json.questions.length < 10) {
                        status.innerText = `⚠️ 10개 중 ${json.questions.length}개만 생성되었습니다. 한 번 더 출제 버튼을 눌러보세요.`;
                    } else {
                        status.innerText = "✨ 실전 어학 퀴즈 10문제 완성!";
                    }
                    
                    renderQuiz(json.questions);
                } else {
                    throw new Error("Invalid API Response");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "❌ 퀴즈 생성 중 오류 발생! 다시 시도해주세요.";
                alert("AI 출제 중 오류가 발생했습니다. 개발자 도구 콘솔을 확인해주세요.");
            } finally {
                genBtn.innerText = "🚀 실전 어학 10문제 출제하기";
                genBtn.disabled = false;
            }
        }

        // 3. 퀴즈 앱 화면 렌더링 (UI 로직 변경)
        function renderQuiz(questions) {
            questions.forEach((q, qIdx) => {
                const qDiv = document.createElement('div');
                qDiv.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg animate-fade-in";
                
                // 보기는 무조건 한국어
                let optionsHtml = q.options.map((opt, oIdx) => `
                    <button onclick="checkAnswer(this, ${qIdx}, ${oIdx}, ${q.a}, '${q.exp.replace(/'/g, "\\'")}')" 
                            class="w-full text-left p-4 rounded-xl bg-slate-900 border border-slate-700 hover:border-emerald-500 transition-all text-sm mb-2 font-medium">
                        ${oIdx + 1}. ${opt}
                    </button>
                `).join('');

                // q_vn(베트남어)는 크고 굵게, q_kr(한국어 지문/번역)는 작고 흐리게
                qDiv.innerHTML = `
                    <p class="font-bold text-lg mb-1 text-emerald-100">${qIdx + 1}. ${q.q_vn}</p>
                    <p class="text-sm text-slate-400 mb-5 break-keep">${q.q_kr}</p>
                    <div id="q-${qIdx}-options">${optionsHtml}</div>
                    <div id="q-${qIdx}-feedback" class="hidden mt-3 text-xs p-4 rounded-xl bg-slate-900 border-l-4 border-emerald-500 text-slate-300 leading-relaxed shadow-inner"></div>
                `;
                quizContainer.appendChild(qDiv);
            });
        }

        // 4. 정답 체크 및 피드백
        function checkAnswer(btn, qIdx, selected, correct, explanation) {
            const optionsDiv = document.getElementById(`q-${qIdx}-options`);
            const feedbackDiv = document.getElementById(`q-${qIdx}-feedback`);
            const buttons = optionsDiv.querySelectorAll('button');

            // 모든 버튼 비활성화
            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-emerald-400 text-base">✅ <strong>Chính xác! (정답!)</strong></span><br><br>${explanation}`;
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
                feedbackDiv.innerHTML = `<span class="text-red-400 text-base">❌ <strong>Sai rồi! (틀렸어요!)</strong></span><br><br>${explanation}`;
            }
            feedbackDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
